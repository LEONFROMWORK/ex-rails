<% content_for :title, "ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì œì–´" %>

<div class="min-h-screen bg-background">
  <div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-bold text-foreground">ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì œì–´</h1>
        <p class="text-muted-foreground mt-2">
          ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš°, ë ˆë”§, ì˜¤ë¹ ë‘ ë°ì´í„° ìˆ˜ì§‘ íŒŒì´í”„ë¼ì¸ì„ ê´€ë¦¬í•˜ì„¸ìš”
        </p>
      </div>
      <div class="flex gap-2">
        <%= button_to admin_data_pipeline_start_collection_path, 
              method: :post, 
              class: "inline-flex items-center px-4 py-2 bg-success hover:bg-success/90 text-primary-foreground rounded-md text-sm font-medium",
              data: { confirm: "ëª¨ë“  ë°ì´í„° ìˆ˜ì§‘ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" } do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h1m4 0h1m-6-8h1m4 0h1M9 6h1m4 0h1m-6 8h1m4 0h1m-6-4h1m4 0h1"></path>
          </svg>
          ëª¨ë“  ìˆ˜ì§‘ ì‹œì‘
        <% end %>
        
        <%= button_to admin_data_pipeline_stop_collection_path, 
              method: :post, 
              class: "inline-flex items-center px-4 py-2 bg-destructive hover:bg-destructive/90 text-primary-foreground rounded-md text-sm font-medium",
              data: { confirm: "ëª¨ë“  ë°ì´í„° ìˆ˜ì§‘ì„ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" } do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h6v4H9z"></path>
          </svg>
          ëª¨ë“  ìˆ˜ì§‘ ì¤‘ì§€
        <% end %>
        
        <%= button_to admin_data_pipeline_restart_failed_path, 
              method: :post, 
              class: "inline-flex items-center px-4 py-2 bg-warning hover:bg-warning/90 text-primary-foreground rounded-md text-sm font-medium",
              data: { confirm: "ì‹¤íŒ¨í•œ ì†ŒìŠ¤ë¥¼ ì¬ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" } do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          ì‹¤íŒ¨í•œ ì†ŒìŠ¤ ì¬ì‹œì‘
        <% end %>
      </div>
    </div>

    <!-- Overall Health Status -->
    <div class="mb-8">
      <div class="bg-card rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold text-foreground mb-4">ì „ì²´ ìƒíƒœ</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-foreground">
              <%= @health_check[:total_sources] %>
            </div>
            <div class="text-sm text-muted-foreground">ì´ ì†ŒìŠ¤</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-success">
              <%= @health_check[:running_sources] %>
            </div>
            <div class="text-sm text-muted-foreground">ì‹¤í–‰ ì¤‘</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-destructive">
              <%= @health_check[:failed_sources] %>
            </div>
            <div class="text-sm text-muted-foreground">ì‹¤íŒ¨</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-muted-foreground">
              <%= @health_check[:stopped_sources] %>
            </div>
            <div class="text-sm text-muted-foreground">ì¤‘ì§€</div>
          </div>
        </div>
        
        <div class="mt-4 flex items-center justify-center">
          <div class="flex items-center">
            <div class="w-3 h-3 rounded-full mr-2 <%= case @health_check[:overall_health]
                                                      when 'healthy' then 'bg-success'
                                                      when 'degraded' then 'bg-warning'
                                                      else 'bg-destructive'
                                                      end %>"></div>
            <span class="text-sm font-medium text-foreground">
              <%= case @health_check[:overall_health]
                  when 'healthy' then 'ì •ìƒ'
                  when 'degraded' then 'ì¼ë¶€ ì¥ì• '
                  else 'ì‹¬ê°í•œ ì¥ì• '
                  end %>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Individual Source Status -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <% @pipeline_status.each do |source, status| %>
        <div class="bg-card rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-foreground">
              <%= case source
                  when 'stackoverflow' then 'ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš°'
                  when 'reddit' then 'ë ˆë”§'
                  when 'oppadu' then 'ì˜¤ë¹ ë‘'
                  else source.titleize
                  end %>
            </h3>
            <div class="flex items-center">
              <div class="w-3 h-3 rounded-full mr-2 <%= case status[:status]
                                                        when 'running' then 'bg-success animate-pulse'
                                                        when 'failed' then 'bg-destructive'
                                                        else 'bg-muted-foreground'
                                                        end %>"></div>
              <span class="text-sm font-medium text-foreground">
                <%= case status[:status]
                    when 'running' then 'ì‹¤í–‰ ì¤‘'
                    when 'failed' then 'ì‹¤íŒ¨'
                    when 'stopped' then 'ì¤‘ì§€'
                    else status[:status]
                    end %>
              </span>
            </div>
          </div>
          
          <div class="space-y-3">
            <div class="flex justify-between text-sm">
              <span class="text-muted-foreground">ìˆ˜ì§‘ëœ í•­ëª©:</span>
              <span class="font-medium text-foreground">
                <%= number_with_delimiter(status[:collected_items]) %>
              </span>
            </div>
            
            <div class="flex justify-between text-sm">
              <span class="text-muted-foreground">ìˆ˜ì§‘ ì†ë„:</span>
              <span class="font-medium text-foreground">
                <%= status[:collection_rate] %> items/min
              </span>
            </div>
            
            <% if status[:last_success_at] %>
              <div class="flex justify-between text-sm">
                <span class="text-muted-foreground">ë§ˆì§€ë§‰ ì„±ê³µ:</span>
                <span class="font-medium text-foreground">
                  <%= time_ago_in_words(status[:last_success_at]) %> ì „
                </span>
              </div>
            <% end %>
            
            <% if status[:error_count] > 0 %>
              <div class="flex justify-between text-sm">
                <span class="text-muted-foreground">ì˜¤ë¥˜ íšŸìˆ˜:</span>
                <span class="font-medium text-destructive">
                  <%= status[:error_count] %>
                </span>
              </div>
            <% end %>
            
            <% if status[:last_error] %>
              <div class="text-sm">
                <span class="text-muted-foreground">ë§ˆì§€ë§‰ ì˜¤ë¥˜:</span>
                <p class="text-destructive text-xs mt-1 truncate">
                  <%= status[:last_error] %>
                </p>
              </div>
            <% end %>
          </div>
          
          <div class="mt-4 flex gap-2">
            <%= button_to admin_data_pipeline_start_collection_path, 
                  method: :post, 
                  params: { sources: [source] },
                  class: "flex-1 px-3 py-2 bg-success hover:bg-success/90 text-primary-foreground rounded text-sm font-medium #{'opacity-50 cursor-not-allowed' if status[:status] == 'running'}",
                  disabled: status[:status] == 'running' do %>
              ì‹œì‘
            <% end %>
            
            <%= button_to admin_data_pipeline_stop_collection_path, 
                  method: :post, 
                  params: { sources: [source] },
                  class: "flex-1 px-3 py-2 bg-destructive hover:bg-destructive/90 text-primary-foreground rounded text-sm font-medium #{'opacity-50 cursor-not-allowed' if status[:status] == 'stopped'}",
                  disabled: status[:status] == 'stopped' do %>
              ì¤‘ì§€
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Real-time Pipeline Logs -->
    <div class="bg-card rounded-lg shadow">
      <div class="p-6 border-b border-border">
        <h2 class="text-xl font-semibold text-foreground">ì‹¤ì‹œê°„ íŒŒì´í”„ë¼ì¸ ë¡œê·¸</h2>
        <p class="text-sm text-muted-foreground mt-1">
          ê° ë°ì´í„° ì†ŒìŠ¤ë³„ë¡œ ìˆ˜ì§‘ë˜ëŠ” ê²Œì‹œë¬¼ì˜ ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”
        </p>
      </div>
      
      <!-- Tab Navigation -->
      <div class="border-b border-border">
        <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
          <button class="pipeline-log-tab border-primary text-primary whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                  data-source="stackoverflow">
            ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš°
          </button>
          <button class="pipeline-log-tab border-transparent text-muted-foreground hover:text-foreground hover:border-border whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                  data-source="reddit">
            ë ˆë”§
          </button>
          <button class="pipeline-log-tab border-transparent text-muted-foreground hover:text-foreground hover:border-border whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" 
                  data-source="oppadu">
            ì˜¤ë¹ ë‘
          </button>
        </nav>
      </div>
      
      <!-- Log Content -->
      <div class="p-6">
        <div id="stackoverflow-logs" class="pipeline-log-content">
          <div class="bg-background rounded-lg p-4 font-mono text-sm text-success h-96 overflow-y-auto" 
               id="stackoverflow-log-container">
            <div class="text-muted-foreground text-center py-8">
              ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš° ë¡œê·¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
            </div>
          </div>
        </div>
        
        <div id="reddit-logs" class="pipeline-log-content hidden">
          <div class="bg-background rounded-lg p-4 font-mono text-sm text-success h-96 overflow-y-auto" 
               id="reddit-log-container">
            <div class="text-muted-foreground text-center py-8">
              ë ˆë”§ ë¡œê·¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
            </div>
          </div>
        </div>
        
        <div id="oppadu-logs" class="pipeline-log-content hidden">
          <div class="bg-background rounded-lg p-4 font-mono text-sm text-success h-96 overflow-y-auto" 
               id="oppadu-log-container">
            <div class="text-muted-foreground text-center py-8">
              ì˜¤ë¹ ë‘ ë¡œê·¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Tab switching functionality
  const tabs = document.querySelectorAll('.pipeline-log-tab');
  const contents = document.querySelectorAll('.pipeline-log-content');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      // Remove active classes
      tabs.forEach(t => {
        t.classList.remove('border-primary', 'text-primary');
        t.classList.add('border-transparent', 'text-muted-foreground');
      });
      
      contents.forEach(c => c.classList.add('hidden'));
      
      // Add active classes
      this.classList.remove('border-transparent', 'text-muted-foreground');
      this.classList.add('border-primary', 'text-primary');
      
      // Show corresponding content
      const source = this.getAttribute('data-source');
      document.getElementById(source + '-logs').classList.remove('hidden');
    });
  });
  
  // WebSocket connection for real-time logs
  const cable = ActionCable.createConsumer();
  
  const logSubscription = cable.subscriptions.create({
    channel: 'DataPipelineChannel'
  }, {
    connected() {
      console.log('Connected to DataPipelineChannel');
    },
    
    disconnected() {
      console.log('Disconnected from DataPipelineChannel');
    },
    
    received(data) {
      handleLogUpdate(data);
    }
  });
  
  function handleLogUpdate(data) {
    const { source, type, message, item } = data;
    const container = document.getElementById(source + '-log-container');
    
    if (!container) return;
    
    // Clear initial waiting message
    const waitingMessage = container.querySelector('.text-center');
    if (waitingMessage) {
      waitingMessage.remove();
    }
    
    const timestamp = new Date().toLocaleTimeString();
    let logEntry = '';
    
    switch(type) {
      case 'collection_start':
        logEntry = `<div class="text-primary mb-2">[${timestamp}] ğŸš€ ${getSourceName(source)} ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘</div>`;
        break;
        
      case 'collection_stop':
        logEntry = `<div class="text-destructive mb-2">[${timestamp}] â¹ï¸ ${getSourceName(source)} ë°ì´í„° ìˆ˜ì§‘ ì¤‘ì§€</div>`;
        break;
        
      case 'item_collected':
        logEntry = formatItemLog(timestamp, source, item);
        break;
        
      case 'batch_complete':
        logEntry = `<div class="text-success mb-2">[${timestamp}] âœ… ë°°ì¹˜ ì™„ë£Œ: ${message}</div>`;
        break;
        
      case 'error':
        logEntry = `<div class="text-destructive mb-2">[${timestamp}] âŒ ì˜¤ë¥˜: ${message}</div>`;
        break;
        
      default:
        logEntry = `<div class="text-muted-foreground mb-2">[${timestamp}] ${message}</div>`;
    }
    
    container.innerHTML += logEntry;
    
    // Auto-scroll to bottom
    container.scrollTop = container.scrollHeight;
  }
  
  function formatItemLog(timestamp, source, item) {
    if (!item) return '';
    
    const title = item.title || 'Untitled';
    const content = item.content || item.answer || '';
    const hasImages = item.has_images || false;
    
    // Truncate content to show preview
    const contentPreview = content.length > 100 ? content.substring(0, 100) + '...' : content;
    
    let logEntry = `<div class="border-l-2 border-primary pl-3 mb-3 text-sm">`;
    logEntry += `<div class="text-foreground font-medium">[${timestamp}] ğŸ“„ ìƒˆ ê²Œì‹œë¬¼ ìˆ˜ì§‘</div>`;
    logEntry += `<div class="text-primary mt-1">ì œëª©: ${title}</div>`;
    
    if (contentPreview) {
      logEntry += `<div class="text-muted-foreground mt-1">ë‚´ìš©: ${contentPreview}</div>`;
    }
    
    if (hasImages) {
      logEntry += `<div class="text-destructive mt-1 font-medium">ğŸ–¼ï¸ ì´ë¯¸ì§€ ìˆìŒ</div>`;
    }
    
    logEntry += `</div>`;
    
    return logEntry;
  }
  
  function getSourceName(source) {
    switch(source) {
      case 'stackoverflow': return 'ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš°';
      case 'reddit': return 'ë ˆë”§';
      case 'oppadu': return 'ì˜¤ë¹ ë‘';
      default: return source;
    }
  }
  
  // Auto-refresh pipeline status every 10 seconds
  setInterval(() => {
    // Only refresh if page is visible
    if (!document.hidden) {
      fetch('/admin/data_pipeline/health_check')
        .then(response => response.json())
        .then(data => {
          updatePipelineStatus(data);
        })
        .catch(error => {
          console.error('Error fetching pipeline status:', error);
        });
    }
  }, 10000);
  
  function updatePipelineStatus(healthCheck) {
    // Update overall health indicators
    const runningCount = document.querySelector('.text-success');
    const failedCount = document.querySelector('.text-destructive');
    const stoppedCount = document.querySelector('.text-muted-foreground');
    
    if (runningCount) runningCount.textContent = healthCheck.running_sources;
    if (failedCount) failedCount.textContent = healthCheck.failed_sources;
    if (stoppedCount) stoppedCount.textContent = healthCheck.stopped_sources;
    
    // Update individual source status indicators
    Object.keys(healthCheck.sources).forEach(source => {
      const status = healthCheck.sources[source];
      const statusIndicator = document.querySelector(`[data-source="${source}"] .w-3.h-3`);
      
      if (statusIndicator) {
        statusIndicator.className = `w-3 h-3 rounded-full mr-2 ${getStatusColor(status.status)}`;
      }
    });
  }
  
  function getStatusColor(status) {
    switch(status) {
      case 'running': return 'bg-success animate-pulse';
      case 'failed': return 'bg-destructive';
      default: return 'bg-muted-foreground';
    }
  }
});
</script>