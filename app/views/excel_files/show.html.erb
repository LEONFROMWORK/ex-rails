<%# Excel 파일 상세 페이지 %>
<div class="container mx-auto px-4 py-8">
  <%= render_card(class: "w-full") do %>
    <div class="p-6">
      <div class="flex justify-between items-start mb-6">
        <div>
          <h1 class="text-3xl font-bold text-card-foreground mb-2">
            <%= @excel_file.original_name %>
          </h1>
          <div class="flex items-center space-x-4 text-sm text-muted-foreground">
            <span class="flex items-center">
              <i class="fas fa-file-excel mr-2 text-success"></i>
              <%= number_to_human_size(@excel_file.file_size) %>
            </span>
            <span class="flex items-center">
              <i class="fas fa-clock mr-2 text-primary"></i>
              <%= time_ago_in_words(@excel_file.created_at) %> ago
            </span>
            <span class="flex items-center">
              <i class="fas fa-circle mr-2 status-<%= @excel_file.status %>"></i>
              <%= @excel_file.status.humanize %>
            </span>
          </div>
        </div>
        
        <div class="flex space-x-3">
          <%= render_button("Download Original", variant: :secondary, as: :link, href: download_excel_file_path(@excel_file)) do %>
            <i class="fas fa-download mr-2"></i>
            Download Original
          <% end %>
          
          <% if @excel_file.can_be_analyzed? %>
            <%= render_button("Re-analyze", variant: :default, onclick: "if(confirm('This will consume credits. Continue?')) { /* submit form */ }") do %>
              <i class="fas fa-sync mr-2"></i>
              Re-analyze
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- 탭 네비게이션 -->
      <%= render_tabs do %>
        <%= tab_list do %>
          <%= tab "Analysis Results", active: true, id: "analysis" do %>
            <i class="fas fa-chart-line mr-2"></i>
            Analysis Results
          <% end %>
          <%= tab "VBA Analysis", id: "vba" do %>
            <i class="fas fa-code mr-2"></i>
            VBA Analysis
          <% end %>
          <%= tab "Formula Analysis", id: "formula" do %>
            <i class="fas fa-calculator mr-2"></i>
            Formula Analysis
          <% end %>
          <%= tab "Image Analysis", id: "image" do %>
            <i class="fas fa-image mr-2"></i>
            Image Analysis
          <% end %>
          <%= tab "AI Modification", id: "modification" do %>
            <i class="fas fa-robot mr-2"></i>
            AI Modification
          <% end %>
          <%= tab "History", id: "history" do %>
            <i class="fas fa-history mr-2"></i>
            History
          <% end %>
        <% end %>

        <%= tab_panels do %>
          <%= tab_panel active: true, id: "analysis" do %>
            <% if @latest_analysis %>
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- 분석 요약 카드 -->
                <%= render_card(
                  title: "Analysis Summary",
                  class: "bg-gradient-to-r from-primary to-primary/80 text-primary-foreground"
                ) do %>
                  <div class="p-6">
                    <div class="flex items-center mb-4">
                      <i class="fas fa-chart-bar mr-2 text-primary-foreground"></i>
                      <h3 class="text-lg font-semibold text-primary-foreground">Analysis Summary</h3>
                    </div>
                    <div class="space-y-2 text-primary-foreground">
                      <p><span class="font-medium">Errors Found:</span> <%= @latest_analysis.detected_errors.size %></p>
                      <p><span class="font-medium">AI Tier:</span> Tier <%= @latest_analysis.ai_tier_used %></p>
                      <p><span class="font-medium">Confidence:</span> <%= number_to_percentage(@latest_analysis.confidence_score * 100, precision: 1) %></p>
                      <p><span class="font-medium">Tokens Used:</span> <%= @latest_analysis.credits_used %></p>
                    </div>
                  </div>
                <% end %>

                <!-- 오류 타입 분포 -->
                <%= render_card(
                  title: "Error Types",
                  class: "border border-border"
                ) do %>
                  <div class="p-6">
                    <div class="flex items-center mb-4">
                      <i class="fas fa-exclamation-triangle mr-2 text-warning"></i>
                      <h3 class="text-lg font-semibold text-card-foreground">Error Types</h3>
                    </div>
                    <div id="error-types-chart" class="h-32"></div>
                  </div>
                <% end %>

                <!-- 처리 시간 -->
                <%= render_card(
                  title: "Processing Info",
                  class: "border border-border"
                ) do %>
                  <div class="p-6">
                    <div class="flex items-center mb-4">
                      <i class="fas fa-stopwatch mr-2 text-success"></i>
                      <h3 class="text-lg font-semibold text-card-foreground">Processing Info</h3>
                    </div>
                    <div class="space-y-2 text-sm">
                      <p><span class="font-medium">Provider:</span> <%= @latest_analysis.provider %></p>
                      <p><span class="font-medium">Analyzed:</span> <%= time_ago_in_words(@latest_analysis.created_at) %> ago</p>
                      <p><span class="font-medium">Status:</span> 
                        <span class="px-2 py-1 rounded text-xs bg-success/10 text-success">
                          <%= @latest_analysis.status.humanize %>
                        </span>
                      </p>
                    </div>
                  </div>
                <% end %>
        </div>

              <!-- AI 분석 결과 -->
              <%= render_card(
                title: "AI Analysis Results",
                class: "mb-6"
              ) do %>
                <div class="p-6">
                  <div class="flex items-center mb-4">
                    <i class="fas fa-robot mr-2 text-purple-600"></i>
                    <h3 class="text-xl font-semibold text-card-foreground">AI Analysis Results</h3>
                  </div>
                  <div class="prose max-w-none text-card-foreground">
                    <%= simple_format(@latest_analysis.ai_analysis) %>
                  </div>
                </div>
              <% end %>

              <!-- 구조화된 분석 (있는 경우) -->
              <% if @latest_analysis.structured_analysis.present? %>
                <%= render_card(
                  title: "Detailed Analysis",
                  class: "mb-6"
                ) do %>
                  <div class="p-6">
                    <div class="flex items-center mb-4">
                      <i class="fas fa-list-ul mr-2 text-indigo-500"></i>
                      <h3 class="text-xl font-semibold text-card-foreground">Detailed Analysis</h3>
                    </div>
                    <div class="space-y-4">
                      <% @latest_analysis.structured_analysis.each do |section, content| %>
                        <div class="border-l-4 border-indigo-500 pl-4">
                          <h4 class="font-semibold text-card-foreground capitalize"><%= section.humanize %></h4>
                          <p class="text-muted-foreground mt-1"><%= content %></p>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% end %>

              <!-- 오류 목록 -->
              <% if @latest_analysis.detected_errors.any? %>
                <%= render_card(
                  title: "Detected Errors (#{@latest_analysis.detected_errors.size})"
                ) do %>
                  <div class="p-6">
                    <div class="flex items-center mb-4">
                      <i class="fas fa-bug mr-2 text-red-500"></i>
                      <h3 class="text-xl font-semibold text-card-foreground">
                        Detected Errors (<%= @latest_analysis.detected_errors.size %>)
                      </h3>
                    </div>
                    <div class="space-y-3">
                      <% @latest_analysis.detected_errors.each_with_index do |error, index| %>
                        <div class="border border-border rounded-lg p-4 hover:bg-accent transition-colors">
                          <div class="flex items-start justify-between">
                            <div class="flex-1">
                              <div class="flex items-center mb-2">
                                <span class="px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800">
                                  <%= error['type']&.humanize || 'Unknown' %>
                                </span>
                                <% if error['location'] %>
                                  <span class="ml-2 text-sm text-muted-foreground">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    <%= error['location'] %>
                                  </span>
                                <% end %>
                              </div>
                              <p class="text-card-foreground font-medium"><%= error['message'] %></p>
                              <% if error['formula'] %>
                                <p class="text-sm text-muted-foreground mt-1 font-mono bg-muted p-2 rounded">
                                  <%= error['formula'] %>
                                </p>
                              <% end %>
                            </div>
                            <span class="text-xs text-muted-foreground">#<%= index + 1 %></span>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% end %>

            <% else %>
              <!-- 분석이 없는 경우 -->
              <div class="text-center py-12">
                <i class="fas fa-chart-line text-6xl text-muted-foreground mb-4"></i>
                <h3 class="text-xl font-semibold text-card-foreground mb-2">No Analysis Available</h3>
                <p class="text-muted-foreground mb-6">This file hasn't been analyzed yet.</p>
                
                <% if @excel_file.can_be_analyzed? %>
                  <%= render_button("Start Analysis", variant: :default, onclick: "if(confirm('This will consume credits. Continue?')) { /* submit form */ }") do %>
                    <i class="fas fa-play mr-2"></i>
                    Start Analysis
                  <% end %>
                <% else %>
                  <p class="text-sm text-destructive">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    File cannot be analyzed in current state: <%= @excel_file.status %>
                  </p>
                <% end %>
              </div>
            <% end %>
          <% end %>

          <%= tab_panel id: "vba" do %>
            <%= render_card(class: "w-full") do %>
              <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                  <div class="flex items-center">
                    <i class="fas fa-code mr-2 text-blue-500"></i>
                    <h3 class="text-xl font-semibold text-card-foreground">VBA Code Analysis</h3>
                  </div>
                  <%= render_button("Analyze VBA (10 credits)", variant: :default, id: "analyze-vba-btn") do %>
                    <i class="fas fa-search mr-2"></i>
                    Analyze VBA (10 credits)
                  <% end %>
                </div>
                
                <div id="vba-results" class="hidden">
                  <!-- VBA 분석 결과가 여기에 표시됩니다 -->
                </div>
                
                <div id="vba-placeholder" class="text-center py-12">
                  <i class="fas fa-code text-6xl text-muted-foreground mb-4"></i>
                  <h4 class="text-lg font-semibold text-card-foreground mb-2">VBA Analysis</h4>
                  <p class="text-muted-foreground mb-4">
                    Analyze VBA code for security issues, performance problems, and code quality.
                  </p>
                  <p class="text-sm text-muted-foreground">
                    This will scan for dangerous functions, inefficient patterns, and provide optimization recommendations.
                  </p>
                </div>
              </div>
            <% end %>
          <% end %>

          <%= tab_panel id: "formula" do %>
            <div data-controller="formula-analysis" 
                 data-formula-analysis-file-id-value="<%= @excel_file.id %>"
                 data-formula-analysis-analysis-data-value="<%= @latest_analysis&.has_formula_analysis? ? {
                   formula_complexity_score: @latest_analysis.formula_complexity_score,
                   formula_count: @latest_analysis.formula_count,
                   formula_functions: @latest_analysis.formula_functions,
                   formula_dependencies: @latest_analysis.formula_dependencies,
                   circular_references: @latest_analysis.circular_references,
                   formula_errors: @latest_analysis.formula_errors,
                   formula_optimization_suggestions: @latest_analysis.formula_optimization_suggestions
                 }.to_json.html_safe : '{}' %>"
                 data-formula-analysis-chart-theme-value="light">
              
              <% if @latest_analysis&.has_formula_analysis? %>
                <!-- 수식 분석 개요 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 formula-stats-grid">
                  <!-- 복잡도 점수 카드 -->
                  <%= render_card(
                    title: "Formula Complexity",
                    class: "bg-gradient-to-r from-purple-500 to-purple-600 text-white"
                  ) do %>
                    <div class="p-6">
                      <div class="flex items-center mb-4">
                        <i class="fas fa-chart-line mr-2 text-white"></i>
                        <h3 class="text-lg font-semibold text-white">Complexity Score</h3>
                      </div>
                      <div class="text-center">
                        <div class="text-4xl font-bold text-white mb-2" data-formula-analysis-target="complexityScore">
                          <%= @latest_analysis.formula_complexity_score&.round(2) || 0 %>
                        </div>
                        <div class="text-white opacity-90" data-formula-analysis-target="complexityLevel">
                          <%= @latest_analysis.formula_complexity_level || 'Unknown' %>
                        </div>
                      </div>
                    </div>
                  <% end %>

                  <!-- 수식 개수 카드 -->
                  <%= render_card(
                    title: "Formula Count",
                    class: "border border-border"
                  ) do %>
                    <div class="p-6">
                      <div class="flex items-center mb-4">
                        <i class="fas fa-calculator mr-2 text-blue-500"></i>
                        <h3 class="text-lg font-semibold text-card-foreground">Total Formulas</h3>
                      </div>
                      <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2" data-formula-analysis-target="formulaCount">
                          <%= @latest_analysis.formula_count || 0 %>
                        </div>
                        <div class="text-sm text-muted-foreground">Found in workbook</div>
                      </div>
                    </div>
                  <% end %>

                  <!-- 함수 종류 카드 -->
                  <%= render_card(
                    title: "Function Types",
                    class: "border border-border"
                  ) do %>
                    <div class="p-6">
                      <div class="flex items-center mb-4">
                        <i class="fas fa-function mr-2 text-green-500"></i>
                        <h3 class="text-lg font-semibold text-card-foreground">Unique Functions</h3>
                      </div>
                      <div class="text-center">
                        <div class="text-3xl font-bold text-green-600 mb-2" data-formula-analysis-target="functionCount">
                          <%= @latest_analysis.formula_functions&.dig('total_functions') || 0 %>
                        </div>
                        <div class="text-sm text-muted-foreground">Different function types</div>
                      </div>
                    </div>
                  <% end %>

                  <!-- 순환 참조 카드 -->
                  <%= render_card(
                    title: "Circular References",
                    class: "border border-border"
                  ) do %>
                    <div class="p-6">
                      <div class="flex items-center mb-4">
                        <i class="fas fa-sync-alt mr-2 text-orange-500"></i>
                        <h3 class="text-lg font-semibold text-card-foreground">Circular Refs</h3>
                      </div>
                      <div class="text-center">
                        <div class="text-3xl font-bold <%= @latest_analysis.has_circular_references? ? 'text-red-600' : 'text-green-600' %> mb-2">
                          <%= @latest_analysis.circular_reference_count %>
                        </div>
                        <div class="text-sm text-muted-foreground">
                          <%= @latest_analysis.has_circular_references? ? 'Need attention' : 'All clear' %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>

                <!-- 함수 사용 분석 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                  <!-- 함수 카테고리 차트 -->
                  <%= render_card(
                    title: "Function Usage by Category"
                  ) do %>
                    <div class="p-6">
                      <div class="flex items-center mb-4">
                        <i class="fas fa-chart-pie mr-2 text-indigo-500"></i>
                        <h3 class="text-xl font-semibold text-card-foreground">Function Categories</h3>
                      </div>
                      <div class="h-64 formula-chart-container">
                        <canvas data-formula-analysis-target="functionChart"></canvas>
                      </div>
                    </div>
                  <% end %>

                  <!-- 상위 함수 테이블 -->
                  <%= render_card(
                    title: "Most Used Functions"
                  ) do %>
                    <div class="p-6">
                      <div class="flex items-center mb-4">
                        <i class="fas fa-list-ol mr-2 text-blue-500"></i>
                        <h3 class="text-xl font-semibold text-card-foreground">Top Functions</h3>
                      </div>
                      <div data-formula-analysis-target="functionTable" class="formula-table-scroll">
                        <!-- 함수 테이블이 여기에 동적으로 생성됩니다 -->
                      </div>
                    </div>
                  <% end %>
                </div>

                <!-- 의존성 분석 -->
                <% if @latest_analysis.formula_dependencies.present? %>
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- 의존성 차트 -->
                    <%= render_card(
                      title: "Formula Dependencies"
                    ) do %>
                      <div class="p-6">
                        <div class="flex items-center mb-4">
                          <i class="fas fa-project-diagram mr-2 text-purple-500"></i>
                          <h3 class="text-xl font-semibold text-card-foreground">Dependencies Overview</h3>
                        </div>
                        <div class="h-64 formula-chart-container">
                          <canvas data-formula-analysis-target="dependencyChart"></canvas>
                        </div>
                      </div>
                    <% end %>

                    <!-- 의존성 통계 -->
                    <%= render_card(
                      title: "Dependency Statistics"
                    ) do %>
                      <div class="p-6">
                        <div class="flex items-center mb-4">
                          <i class="fas fa-sitemap mr-2 text-teal-500"></i>
                          <h3 class="text-xl font-semibold text-card-foreground">Dependency Stats</h3>
                        </div>
                        <div class="space-y-4">
                          <div class="flex justify-between items-center">
                            <span class="text-muted-foreground">Direct Dependencies:</span>
                            <span class="font-semibold">
                              <%= @latest_analysis.formula_dependencies&.dig('direct_dependencies')&.size || 0 %>
                            </span>
                          </div>
                          <div class="flex justify-between items-center">
                            <span class="text-muted-foreground">Indirect Dependencies:</span>
                            <span class="font-semibold">
                              <%= @latest_analysis.formula_dependencies&.dig('indirect_dependencies')&.size || 0 %>
                            </span>
                          </div>
                          <div class="flex justify-between items-center">
                            <span class="text-muted-foreground">Nested Formulas:</span>
                            <span class="font-semibold">
                              <%= @latest_analysis.formula_dependencies&.dig('nested_formulas')&.size || 0 %>
                            </span>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% end %>

                <!-- 순환 참조 경고 -->
                <% if @latest_analysis.has_circular_references? %>
                  <%= render_card(
                    title: "Circular References Warning",
                    class: "mb-6 border-red-200 bg-red-50"
                  ) do %>
                    <div class="p-6">
                      <div class="flex items-center mb-4">
                        <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>
                        <h3 class="text-xl font-semibold text-red-900">
                          Circular References Detected (<%= @latest_analysis.circular_reference_count %>)
                        </h3>
                      </div>
                      <div data-formula-analysis-target="circularRefList">
                        <!-- 순환 참조 목록이 여기에 동적으로 생성됩니다 -->
                      </div>
                    </div>
                  <% end %>
                <% end %>

                <!-- 수식 오류 -->
                <% if @latest_analysis.formula_error_count > 0 %>
                  <%= render_card(
                    title: "Formula Errors (#{@latest_analysis.formula_error_count})",
                    class: "mb-6"
                  ) do %>
                    <div class="p-6">
                      <div class="flex items-center mb-4">
                        <i class="fas fa-bug mr-2 text-red-500"></i>
                        <h3 class="text-xl font-semibold text-card-foreground">
                          Formula Errors (<%= @latest_analysis.formula_error_count %>)
                        </h3>
                      </div>
                      <div data-formula-analysis-target="errorsList">
                        <!-- 오류 목록이 여기에 동적으로 생성됩니다 -->
                      </div>
                    </div>
                  <% end %>
                <% end %>

                <!-- 최적화 제안 -->
                <% if @latest_analysis.optimization_suggestion_count > 0 %>
                  <%= render_card(
                    title: "Optimization Suggestions (#{@latest_analysis.optimization_suggestion_count})"
                  ) do %>
                    <div class="p-6">
                      <div class="flex items-center mb-4">
                        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                        <h3 class="text-xl font-semibold text-card-foreground">
                          Optimization Suggestions (<%= @latest_analysis.optimization_suggestion_count %>)
                        </h3>
                      </div>
                      <div data-formula-analysis-target="optimizationList">
                        <!-- 최적화 제안이 여기에 동적으로 생성됩니다 -->
                      </div>
                    </div>
                  <% end %>
                <% end %>

              <% else %>
                <!-- 수식 분석이 없는 경우 -->
                <div class="text-center py-12">
                  <i class="fas fa-calculator text-6xl text-muted-foreground mb-4"></i>
                  <h3 class="text-xl font-semibold text-card-foreground mb-2">No Formula Analysis Available</h3>
                  <p class="text-muted-foreground mb-6">This file hasn't been analyzed for formulas yet, or no formulas were found.</p>
                  
                  <% if @excel_file.can_be_analyzed? %>
                    <%= render_button("Analyze Formulas", variant: :default, id: "analyze-formulas-btn") do %>
                      <i class="fas fa-play mr-2"></i>
                      Analyze Formulas (5 credits)
                    <% end %>
                  <% else %>
                    <p class="text-sm text-destructive">
                      <i class="fas fa-exclamation-circle mr-1"></i>
                      File cannot be analyzed in current state: <%= @excel_file.status %>
                    </p>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>

    <!-- 이미지 분석 탭 -->
    <div id="image-tab" class="tab-content hidden">
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-6 text-gray-900">
          <i class="fas fa-image mr-2 text-green-500"></i>
          Image Analysis
        </h3>
        
        <!-- 이미지 업로드 영역 -->
        <div id="image-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
          <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
          <h4 class="text-lg font-semibold text-gray-900 mb-2">Upload Excel Screenshot</h4>
          <p class="text-gray-600 mb-4">
            Upload a screenshot of your Excel sheet, chart, or formula for AI analysis
          </p>
          <input type="file" id="image-file-input" accept="image/*" class="hidden">
          <button id="upload-image-btn" class="btn btn-primary">
            <i class="fas fa-upload mr-2"></i>
            Choose Image
          </button>
          <p class="text-xs text-gray-500 mt-2">
            Supports: JPG, PNG, GIF, WebP (max 20MB)
          </p>
        </div>

        <!-- 분석 타입 선택 -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Analysis Type</label>
          <select id="image-analysis-type" class="form-select">
            <option value="general">General Excel Analysis</option>
            <option value="chart_analysis">Chart & Graph Analysis</option>
            <option value="formula_visualization">Formula Analysis</option>
          </select>
        </div>

        <!-- 추가 프롬프트 -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Additional Instructions (Optional)</label>
          <textarea id="image-prompt" 
                    rows="3" 
                    class="form-textarea" 
                    placeholder="Describe what you want to know about this image..."></textarea>
        </div>

        <div class="flex justify-end">
          <button id="analyze-image-btn" class="btn btn-primary" disabled>
            <i class="fas fa-magic mr-2"></i>
            Analyze Image (20 credits)
          </button>
        </div>

        <!-- 이미지 분석 결과 -->
        <div id="image-analysis-results" class="hidden mt-8">
          <!-- 결과가 여기에 표시됩니다 -->
        </div>
      </div>
    </div>

    <!-- AI 수정 탭 -->
    <%= tab_panel id: "modification" do %>
      <%= render 'modification_section' %>
    <% end %>

    <!-- 히스토리 탭 -->
    <div id="history-tab" class="tab-content hidden">
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h3 class="text-xl font-semibold mb-6 text-gray-900">
          <i class="fas fa-history mr-2 text-purple-500"></i>
          Analysis History
        </h3>
        
        <div id="analysis-history">
          <!-- 히스토리가 여기에 로드됩니다 -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // 탭 전환 기능
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetTab = button.getAttribute('data-tab');
      
      // 모든 탭 버튼 비활성화
      tabButtons.forEach(btn => {
        btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
      });
      
      // 클릭된 탭 버튼 활성화
      button.classList.add('active', 'border-blue-500', 'text-blue-600');
      button.classList.remove('border-transparent', 'text-gray-500');
      
      // 모든 탭 콘텐츠 숨기기
      tabContents.forEach(content => {
        content.classList.add('hidden');
      });
      
      // 선택된 탭 콘텐츠 표시
      document.getElementById(`${targetTab}-tab`).classList.remove('hidden');
    });
  });

  // VBA 분석 기능
  const analyzeVbaBtn = document.getElementById('analyze-vba-btn');
  if (analyzeVbaBtn) {
    analyzeVbaBtn.addEventListener('click', function() {
      if (!confirm('VBA 분석은 10토큰을 소모합니다. 계속하시겠습니까?')) {
        return;
      }

      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';

      fetch(`<%= analyze_vba_excel_file_path(@excel_file) %>`, {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          displayVbaResults(data);
          document.getElementById('vba-placeholder').classList.add('hidden');
          document.getElementById('vba-results').classList.remove('hidden');
        } else {
          alert('VBA 분석 실패: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('VBA 분석 중 오류가 발생했습니다.');
      })
      .finally(() => {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-search mr-2"></i>Analyze VBA (10 credits)';
      });
    });
  }

  // 수식 분석 기능
  const analyzeFormulasBtn = document.getElementById('analyze-formulas-btn');
  if (analyzeFormulasBtn) {
    analyzeFormulasBtn.addEventListener('click', function() {
      if (!confirm('수식 분석은 5토큰을 소모합니다. 계속하시겠습니까?')) {
        return;
      }

      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing Formulas...';

      fetch(`<%= analyze_formulas_excel_file_path(@excel_file) %>`, {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 성공 시 페이지 새로고침으로 결과 표시
          location.reload();
        } else {
          alert('수식 분석 실패: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('수식 분석 중 오류가 발생했습니다.');
      })
      .finally(() => {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-play mr-2"></i>Analyze Formulas (5 credits)';
      });
    });
  }

  // 이미지 업로드 기능
  const uploadImageBtn = document.getElementById('upload-image-btn');
  const imageFileInput = document.getElementById('image-file-input');
  const analyzeImageBtn = document.getElementById('analyze-image-btn');

  if (uploadImageBtn && imageFileInput) {
    uploadImageBtn.addEventListener('click', () => {
      imageFileInput.click();
    });

    imageFileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // 파일 크기 체크 (20MB)
        if (file.size > 20 * 1024 * 1024) {
          alert('파일 크기는 20MB를 초과할 수 없습니다.');
          return;
        }

        // 이미지 미리보기 표시
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewHtml = `
            <div class="mt-4 p-4 border border-gray-200 rounded-lg">
              <h5 class="font-medium text-gray-900 mb-2">Selected Image:</h5>
              <img src="${e.target.result}" class="max-w-full max-h-64 mx-auto rounded-lg shadow-sm">
              <p class="text-sm text-gray-600 mt-2">${file.name} (${(file.size / 1024).toFixed(1)} KB)</p>
            </div>
          `;
          document.getElementById('image-upload-area').insertAdjacentHTML('afterend', previewHtml);
          analyzeImageBtn.disabled = false;
        };
        reader.readAsDataURL(file);
      }
    });

    // 이미지 분석 실행
    analyzeImageBtn.addEventListener('click', function() {
      const file = imageFileInput.files[0];
      const analysisType = document.getElementById('image-analysis-type').value;
      const prompt = document.getElementById('image-prompt').value || 
                    'Please analyze this Excel-related image and provide insights.';

      if (!file) {
        alert('이미지를 먼저 선택해주세요.');
        return;
      }

      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';

      const formData = new FormData();
      formData.append('image', file);
      formData.append('prompt', prompt);
      formData.append('analysis_type', analysisType);

      fetch('/ai_integration/multimodal/analyze_image', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          displayImageAnalysisResults(data);
          document.getElementById('image-analysis-results').classList.remove('hidden');
        } else {
          alert('이미지 분석 실패: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('이미지 분석 중 오류가 발생했습니다.');
      })
      .finally(() => {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-magic mr-2"></i>Analyze Image (20 credits)';
      });
    });
  }
});

function displayVbaResults(data) {
  const resultsHtml = `
    <div class="space-y-6">
      <!-- 전체 점수 -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
          <h4 class="font-semibold text-blue-900">Overall Score</h4>
          <p class="text-2xl font-bold text-blue-600">${data.overall_score.overall_score}/100</p>
          <p class="text-sm text-blue-700">Grade: ${data.overall_score.grade}</p>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
          <h4 class="font-semibold text-green-900">Code Quality</h4>
          <p class="text-2xl font-bold text-green-600">${data.overall_score.breakdown.code_quality}</p>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
          <h4 class="font-semibold text-red-900">Security</h4>
          <p class="text-2xl font-bold text-red-600">${data.overall_score.breakdown.security}</p>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
          <h4 class="font-semibold text-yellow-900">Performance</h4>
          <p class="text-2xl font-bold text-yellow-600">${data.overall_score.breakdown.performance}</p>
        </div>
      </div>

      <!-- 보안 분석 -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h4 class="font-semibold text-gray-900 mb-4">
          <i class="fas fa-shield-alt mr-2 text-red-500"></i>
          Security Analysis
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p><span class="font-medium">Risk Level:</span> 
              <span class="px-2 py-1 rounded text-xs font-medium bg-${getRiskColor(data.security_analysis.risk_level)}-100 text-${getRiskColor(data.security_analysis.risk_level)}-800">
                ${data.security_analysis.risk_level.toUpperCase()}
              </span>
            </p>
            <p><span class="font-medium">Total Issues:</span> ${data.security_analysis.total_security_issues}</p>
          </div>
          <div>
            <p><span class="font-medium">Risk Score:</span> ${data.security_analysis.risk_score}/100</p>
          </div>
        </div>
      </div>

      <!-- 복잡도 분석 -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h4 class="font-semibold text-gray-900 mb-4">
          <i class="fas fa-chart-bar mr-2 text-purple-500"></i>
          Complexity Analysis
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p><span class="font-medium">Modules Found:</span> ${data.modules_found}</p>
            <p><span class="font-medium">Average Complexity:</span> ${data.complexity_analysis.average_complexity}</p>
          </div>
          <div>
            <p><span class="font-medium">Total Complexity:</span> ${data.complexity_analysis.total_complexity}</p>
          </div>
        </div>
      </div>

      <!-- 추천사항 -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h4 class="font-semibold text-gray-900 mb-4">
          <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
          Recommendations
        </h4>
        <ul class="space-y-2">
          ${data.recommendations.map(rec => `
            <li class="flex items-start">
              <i class="fas fa-check-circle mr-2 text-green-500 mt-1"></i>
              <span>${rec.action} - <em>${rec.impact}</em></span>
            </li>
          `).join('')}
        </ul>
      </div>
    </div>
  `;
  
  document.getElementById('vba-results').innerHTML = resultsHtml;
}

function displayImageAnalysisResults(data) {
  const resultsHtml = `
    <div class="bg-white border border-gray-200 rounded-lg p-6">
      <h4 class="font-semibold text-gray-900 mb-4">
        <i class="fas fa-magic mr-2 text-blue-500"></i>
        AI Image Analysis Results
      </h4>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="text-center">
          <p class="text-sm text-gray-600">Confidence Score</p>
          <p class="text-2xl font-bold text-blue-600">${(data.confidence_score * 100).toFixed(1)}%</p>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-600">Tokens Used</p>
          <p class="text-2xl font-bold text-green-600">${data.credits_used}</p>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-600">Processing Time</p>
          <p class="text-2xl font-bold text-purple-600">${data.processing_time.toFixed(2)}s</p>
        </div>
      </div>

      <div class="prose max-w-none">
        <h5>Analysis:</h5>
        <div class="bg-gray-50 p-4 rounded-lg">
          ${data.analysis.replace(/\\n/g, '<br>')}
        </div>
      </div>

      ${data.cost_saved ? `
        <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
          <p class="text-sm text-green-800">
            <i class="fas fa-piggy-bank mr-2"></i>
            Cost savings achieved with Gemini multimodal AI!
          </p>
        </div>
      ` : ''}
    </div>
  `;
  
  document.getElementById('image-analysis-results').innerHTML = resultsHtml;
}

function getRiskColor(riskLevel) {
  switch(riskLevel) {
    case 'critical': return 'red';
    case 'high': return 'orange';
    case 'medium': return 'yellow';
    case 'low': return 'green';
    default: return 'gray';
  }
}
</script>

<!-- CSS Styles -->
<style>
.status-uploaded { color: #10b981; }
.status-processing { color: #f59e0b; }
.status-analyzed { color: #3b82f6; }
.status-failed { color: #ef4444; }

.btn {
  @apply px-4 py-2 rounded-lg font-medium transition-colors duration-200;
}

.btn-primary {
  @apply bg-blue-600 text-white hover:bg-blue-700;
}

.btn-secondary {
  @apply bg-gray-600 text-white hover:bg-gray-700;
}

.form-select, .form-textarea {
  @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
}

.tab-button.active {
  @apply border-blue-500 text-blue-600;
}

/* Formula Analysis 관련 스타일 */
.formula-complexity-low {
  @apply bg-green-100 text-green-800;
}

.formula-complexity-medium {
  @apply bg-yellow-100 text-yellow-800;
}

.formula-complexity-high {
  @apply bg-orange-100 text-orange-800;
}

.formula-complexity-very-high {
  @apply bg-red-100 text-red-800;
}

.formula-chart-container {
  position: relative;
  height: 300px;
  width: 100%;
}

.formula-stats-card {
  @apply bg-white border border-gray-200 rounded-lg shadow-sm;
  transition: all 0.2s ease-in-out;
}

.formula-stats-card:hover {
  @apply shadow-md border-gray-300;
}

.formula-error-card {
  @apply border-l-4 border-red-500 bg-red-50 p-4 rounded-r-lg;
}

.formula-suggestion-card {
  @apply border-l-4 border-blue-500 bg-blue-50 p-4 rounded-r-lg;
}

.circular-ref-warning {
  @apply border-l-4 border-red-500 bg-red-50 p-4 rounded-r-lg;
}

.function-category-badge {
  @apply px-2 py-1 text-xs font-medium rounded-full;
}

.priority-high {
  @apply bg-red-100 text-red-800;
}

.priority-medium {
  @apply bg-yellow-100 text-yellow-800;
}

.priority-low {
  @apply bg-blue-100 text-blue-800;
}

.severity-high {
  @apply bg-red-100 text-red-800;
}

.severity-medium {
  @apply bg-yellow-100 text-yellow-800;
}

.severity-low {
  @apply bg-green-100 text-green-800;
}

/* 반응형 차트 컨테이너 */
@media (max-width: 768px) {
  .formula-chart-container {
    height: 250px;
  }
  
  .formula-stats-grid {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}

@media (max-width: 640px) {
  .formula-stats-grid {
    grid-template-columns: 1fr !important;
  }
  
  .formula-chart-container {
    height: 200px;
  }
}

/* 애니메이션 */
.formula-number-animation {
  animation: countUp 1s ease-out;
}

@keyframes countUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.formula-fade-in {
  animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* 토글 버튼 */
.formula-toggle-btn {
  @apply inline-flex items-center px-3 py-1 text-sm font-medium rounded-full transition-colors;
}

.formula-toggle-btn.active {
  @apply bg-blue-600 text-white;
}

.formula-toggle-btn:not(.active) {
  @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
}

/* 프로그레스 바 */
.formula-progress {
  @apply w-full bg-gray-200 rounded-full h-2;
}

.formula-progress-bar {
  @apply bg-blue-600 h-2 rounded-full transition-all duration-300;
}

/* 스크롤 가능한 테이블 */
.formula-table-scroll {
  max-height: 400px;
  overflow-y: auto;
}

.formula-table-scroll::-webkit-scrollbar {
  width: 6px;
}

.formula-table-scroll::-webkit-scrollbar-track {
  @apply bg-gray-100 rounded;
}

.formula-table-scroll::-webkit-scrollbar-thumb {
  @apply bg-gray-400 rounded hover:bg-gray-500;
}

/* 다크 모드 지원 */
@media (prefers-color-scheme: dark) {
  .formula-stats-card {
    @apply bg-gray-800 border-gray-700 text-white;
  }
  
  .formula-error-card {
    @apply bg-red-900 border-red-600;
  }
  
  .formula-suggestion-card {
    @apply bg-blue-900 border-blue-600;
  }
  
  .circular-ref-warning {
    @apply bg-red-900 border-red-600;
  }
}
</style>